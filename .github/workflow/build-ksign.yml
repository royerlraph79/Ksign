name: Build Ksign (Debug & Release)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-15
    strategy:
      fail-fast: false
      matrix:
        config: [Release, Debug]

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: true
          fetch-depth: 0

      - name: Use Xcode 16.4
        run: sudo xcode-select -s /Applications/Xcode_16.4.app/Contents/Developer

      - name: Set build version from commit
        run: agvtool new-version -all "$(git rev-parse HEAD)"

      - name: Build ${{ matrix.config }}
        run: |
          make CONFIGURATION="${{ matrix.config }}"
          mkdir -p "upload/${{ matrix.config }}"
          mv "packages/Ksign-${{ matrix.config }}.ipa" "upload/${{ matrix.config }}/"

      - name: Upload artifact (${{ matrix.config }})
        uses: actions/upload-artifact@v4
        with:
          name: Ksign-${{ matrix.config }}
          path: upload/${{ matrix.config }}/*

  release:
    runs-on: macos-15
    needs: build
    steps:
      - name: Checkout (for version info)
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          pattern: Ksign-*
          merge-multiple: true

      - name: Show files
        run: ls -lahR dist

      - name: Determine version
        shell: bash
        run: |
          # Try MARKETING_VERSION from the project; fallback to date+sha
          VERSION="$(agvtool what-marketing-version -terse1 2>/dev/null | tail -n1 || true)"
          if [ -z "$VERSION" ]; then VERSION="$(date +%Y.%m.%d)-$(git rev-parse --short HEAD)"; fi
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"

      - name: Create/Update draft release
        uses: softprops/action-gh-release@v2
        with:
          name: Ksign v${{ env.VERSION }}
          tag_name: v${{ env.VERSION }}
          files: |
            dist/**/*
          generate_release_notes: true
          draft: true
          fail_on_unmatched_files: false
          token: ${{ secrets.GITHUB_TOKEN }}
